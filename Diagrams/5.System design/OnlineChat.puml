@startuml OnlineChat
title Online Chat Data Flow (SignalR)

actor "Registered\nUser" as User
participant "Browser" as Browser
participant "SignalR Hub\n(ChatHub)" as Hub
participant "Administrator/Seller" as AdminOrSeller

User -> Browser : Opens "Online Support"
Browser -> Hub : Establishes SignalR connection
activate Hub

Hub -> Browser : Sends list of available Admin/Sellers
note right
The list is automatically
updated on change.
end note

User -> Browser : Selects Admin/Seller (double-click)
Browser -> Hub : Sends chat request (SendChatRequest)

activate AdminOrSeller
AdminOrSeller -> Hub : Receives chat request notification
deactivate AdminOrSeller

alt Request is accepted within 10 sec.
    AdminOrSeller -> Hub : Sends request acceptance (AcceptChatRequest)
    Hub -> User : Notifies that the request is accepted (ReceiveChatSession)
    Hub -> AdminOrSeller : Notifies that the chat is starting (ReceiveChatSession)
    Hub -> Browser : Updates the list for all users (UpdateSellersList)
else Request is not accepted within 10 sec.
    AdminOrSeller -> Hub : Request expired
    Hub -> User : Notifies that the request is denied (ReceiveChatRequestDenied)
    Hub -> Browser : Updates the list for all users (UpdateSellersList)
end

alt Communication during chat
    User -> Hub : Sends message (SendPrivateMessage)
    Hub -> AdminOrSeller : Forwards the message
    AdminOrSeller -> Hub : Sends message
    Hub -> User : Forwards the message
end

alt Leaving the chat
    User -> Hub : Leaves the chat (LeaveChat)
    Hub -> AdminOrSeller : Notifies that User has left (NotifyChatLeft)
    Hub -> Hub : Chat closes automatically after 3 seconds
    Hub -> Browser : Updates the list for all users (UpdateSellersList)
    
    AdminOrSeller -> Hub : Leaves the chat
    Hub -> User : Notifies that AdminOrSeller has left
    Hub -> Hub : Chat closes automatically after 3 seconds
    Hub -> Browser : Updates the list for all users
end
@enduml